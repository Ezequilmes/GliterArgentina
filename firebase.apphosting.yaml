runtime: nodejs20
entrypoint: node .next/standalone/server.js

env:
  - variable: NODE_ENV
    value: production
  - variable: NEXT_TELEMETRY_DISABLED
    value: "1"
  - variable: PORT
    value: "8080"
  - variable: NEXT_PUBLIC_APP_URL
    value: "https://gliter.com.ar"
    availability:
      - BUILD
      - RUNTIME
  # Disable sharp to avoid native module build issues in App Hosting
  - variable: NEXT_SHARP_DISABLE
    value: "true"
  # Firebase Admin SDK configuration - Set these in Firebase Console -> App Hosting -> Environment Variables
  - variable: FIREBASE_PROJECT_ID
    availability:
      - BUILD
      - RUNTIME
  - variable: FIREBASE_PRIVATE_KEY_ID
    availability:
      - BUILD
      - RUNTIME
  - variable: FIREBASE_PRIVATE_KEY
    availability:
      - BUILD
      - RUNTIME
  - variable: FIREBASE_CLIENT_EMAIL
    availability:
      - BUILD
      - RUNTIME
  - variable: FIREBASE_CLIENT_ID
    availability:
      - BUILD
      - RUNTIME
  # MercadoPago configuration - Set these in Firebase Console -> App Hosting -> Environment Variables
  - variable: MERCADOPAGO_ACCESS_TOKEN
    value: "APP_USR-2100654215920021-090302-fcde5bf150a88e7b9f2223ca0dd2a1e0-93900446"
    availability:
      - RUNTIME
  - variable: NEXT_PUBLIC_MERCADOPAGO_PUBLIC_KEY
    value: "APP_USR-eef5b234-f79b-46ab-aa28-ffd2369f8060"
    availability:
      - BUILD
      - RUNTIME
  - variable: MERCADOPAGO_WEBHOOK_SECRET
    value: "6123b18eb72dba618750cb40a49ea1d26440e748bcf25dd13ce08f8a5fcfe2f2"
    availability:
      - RUNTIME
  - variable: MERCADOPAGO_WEBHOOK_URL
    value: "https://gliter.com.ar/api/mercadopago/webhook"
    availability:
      - RUNTIME
  - variable: MERCADOPAGO_STATEMENT_DESCRIPTOR
    value: "GLITER"
    availability:
      - RUNTIME
  # Firebase Web Push VAPID public key - ensure this is configured in App Hosting env
  - variable: NEXT_PUBLIC_FIREBASE_VAPID_KEY
    value: "BGVjAOjpQTeTCnmNcFrrLHsaHA7a1KSSsn7n0msDXz_0kH_rIkuqNUwYRQn4BnH0-fa-pY24OW3rZDYKwUYbPW4"
    availability:
      - BUILD
      - RUNTIME

build:
  command: |
    echo ">>> Cleaning node state"
    rm -rf node_modules pnpm-lock.yaml
    echo ">>> Installing dependencies"
    npm ci --omit=dev
    echo ">>> Building Next.js app"
    NODE_OPTIONS="--max_old_space_size=4096" npm run build
    echo ">>> Copying public assets for standalone server"
    cp -r public .next/standalone/public || echo "No public directory copied"
  environment:
    - variable: NODE_ENV
      value: production

resources:
  cpu: 2
  memoryMiB: 8192
  diskMiB: 8192

handlers:
  - glob: '**'
    script: auto
